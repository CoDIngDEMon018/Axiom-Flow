{
  "version": 3,
  "sources": ["../../../src/trigger/crop.ts"],
  "sourcesContent": ["\r\nimport { task } from \"@trigger.dev/sdk/v3\";\r\nimport ffmpeg from \"fluent-ffmpeg\";\r\nimport ffmpegInstaller from \"@ffmpeg-installer/ffmpeg\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport os from \"os\";\r\nimport { uploadToTransloadit } from \"./utils\";\r\nimport https from \"https\";\r\nimport { text } from \"stream/consumers\";\r\n\r\n// Set ffmpeg path\r\nffmpeg.setFfmpegPath(ffmpegInstaller.path);\r\n\r\ntype CropPayload = {\r\n    imageUrl: string;\r\n    x?: string | number;\r\n    y?: string | number;\r\n    width?: string | number;\r\n    height?: string | number;\r\n};\r\n\r\n// Helper for simple download\r\nasync function downloadFile(url: string, dest: string): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n        const file = fs.createWriteStream(dest);\r\n        https.get(url, (response) => {\r\n            response.pipe(file);\r\n            file.on('finish', () => {\r\n                file.close();\r\n                resolve();\r\n            });\r\n        }).on('error', (err) => {\r\n            fs.unlink(dest, () => { });\r\n            reject(err);\r\n        });\r\n    });\r\n}\r\n\r\nexport const cropTask = task({\r\n    id: \"crop-task\",\r\n    retry: {\r\n        maxAttempts: 3,\r\n    },\r\n    run: async (payload: CropPayload) => {\r\n        const { imageUrl, x = 0, y = 0, width = \"100%\", height = \"100%\" } = payload;\r\n\r\n        console.log(\"Starting crop task:\", payload);\r\n\r\n        const tmpDir = os.tmpdir();\r\n        const inputPath = path.join(tmpDir, `input-${Date.now()}.jpg`);\r\n        const outputPath = path.join(tmpDir, `output-${Date.now()}.jpg`);\r\n\r\n        try {\r\n            // 1. Download Image\r\n            await downloadFile(imageUrl, inputPath);\r\n            console.log(\"Downloaded image to:\", inputPath);\r\n\r\n            // 2. Crop using ffmpeg\r\n            // Filters format: \"crop=w:h:x:y\"\r\n            // If percentages are used (e.g. \"80%\"), we might need valid ffmpeg syntax or parse them.\r\n            // ffmpeg crop filter supports expressions like \"in_w*0.5\" for 50%.\r\n\r\n            // Normalize inputs to strings for easy parsing check\r\n            const sW = String(width).replace('%', '') || \"100\";\r\n            const sH = String(height).replace('%', '') || \"100\";\r\n            const sX = String(x).replace('%', '') || \"0\";\r\n            const sY = String(y).replace('%', '') || \"0\";\r\n\r\n            // Construct filter value assuming % input implies scaling relative to input size \"in_w\" / \"in_h\"\r\n            // If pure number provided without %, assume pixels? Or percent? Assignment says \"Configurable crop parameters (x%, y%, width%, height%)\" implies percent is standard.\r\n            // Let's assume input is 0-100.\r\n\r\n            // w = in_w * (val/100)\r\n            const wExpr = `in_w*(${sW}/100)`;\r\n            const hExpr = `in_h*(${sH}/100)`;\r\n            const xExpr = `in_w*(${sX}/100)`;\r\n            const yExpr = `in_h*(${sY}/100)`;\r\n\r\n            const filterString = `crop=${wExpr}:${hExpr}:${xExpr}:${yExpr}`;\r\n            console.log(\"Applying filter:\", filterString);\r\n\r\n            await new Promise<void>((resolve, reject) => {\r\n                ffmpeg(inputPath)\r\n                    .outputOptions([`-vf ${filterString}`])\r\n                    .save(outputPath)\r\n                    .on('end', () => resolve())\r\n                    .on('error', (err) => reject(err));\r\n            });\r\n            console.log(\"Cropped image saved to:\", outputPath);\r\n\r\n            // 3. Upload to Transloadit\r\n            const url = await uploadToTransloadit(outputPath, 'cropped.jpg');\r\n            console.log(\"Uploaded result:\", url);\r\n\r\n            // Cleanup\r\n            fs.unlinkSync(inputPath);\r\n            fs.unlinkSync(outputPath);\r\n\r\n            return { url };\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Crop Task Failed:\", error);\r\n            // Cleanup on error\r\n            if (fs.existsSync(inputPath)) fs.unlinkSync(inputPath);\r\n            if (fs.existsSync(outputPath)) fs.unlinkSync(outputPath);\r\n            throw error;\r\n        }\r\n    },\r\n});\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAEA,2BAAmB;AACnB,oBAA4B;AAC5B,OAAO,QAAQ;AACf,OAAO,UAAU;AACjB,OAAO,QAAQ;AAEf,OAAO,WAAW;AAIlB,qBAAAA,QAAO,cAAc,cAAAC,QAAgB,IAAI;AAWzC,eAAe,aAAa,KAAa,MAA6B;AAClE,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpC,UAAM,OAAO,GAAG,kBAAkB,IAAI;AACtC,UAAM,IAAI,KAAK,CAAC,aAAa;AACzB,eAAS,KAAK,IAAI;AAClB,WAAK,GAAG,UAAU,MAAM;AACpB,aAAK,MAAM;AACX,gBAAQ;AAAA,MACZ,CAAC;AAAA,IACL,CAAC,EAAE,GAAG,SAAS,CAAC,QAAQ;AACpB,SAAG,OAAO,MAAM,MAAM;AAAA,MAAE,CAAC;AACzB,aAAO,GAAG;AAAA,IACd,CAAC;AAAA,EACL,CAAC;AACL;AAde;AAgBR,IAAM,WAAW,KAAK;AAAA,EACzB,IAAI;AAAA,EACJ,OAAO;AAAA,IACH,aAAa;AAAA,EACjB;AAAA,EACA,KAAK,8BAAO,YAAyB;AACjC,UAAM,EAAE,UAAU,IAAI,GAAG,IAAI,GAAG,QAAQ,QAAQ,SAAS,OAAO,IAAI;AAEpE,YAAQ,IAAI,uBAAuB,OAAO;AAE1C,UAAM,SAAS,GAAG,OAAO;AACzB,UAAM,YAAY,KAAK,KAAK,QAAQ,SAAS,KAAK,IAAI,CAAC,MAAM;AAC7D,UAAM,aAAa,KAAK,KAAK,QAAQ,UAAU,KAAK,IAAI,CAAC,MAAM;AAE/D,QAAI;AAEA,YAAM,aAAa,UAAU,SAAS;AACtC,cAAQ,IAAI,wBAAwB,SAAS;AAQ7C,YAAM,KAAK,OAAO,KAAK,EAAE,QAAQ,KAAK,EAAE,KAAK;AAC7C,YAAM,KAAK,OAAO,MAAM,EAAE,QAAQ,KAAK,EAAE,KAAK;AAC9C,YAAM,KAAK,OAAO,CAAC,EAAE,QAAQ,KAAK,EAAE,KAAK;AACzC,YAAM,KAAK,OAAO,CAAC,EAAE,QAAQ,KAAK,EAAE,KAAK;AAOzC,YAAM,QAAQ,SAAS,EAAE;AACzB,YAAM,QAAQ,SAAS,EAAE;AACzB,YAAM,QAAQ,SAAS,EAAE;AACzB,YAAM,QAAQ,SAAS,EAAE;AAEzB,YAAM,eAAe,QAAQ,KAAK,IAAI,KAAK,IAAI,KAAK,IAAI,KAAK;AAC7D,cAAQ,IAAI,oBAAoB,YAAY;AAE5C,YAAM,IAAI,QAAc,CAAC,SAAS,WAAW;AACzC,iCAAAD,SAAO,SAAS,EACX,cAAc,CAAC,OAAO,YAAY,EAAE,CAAC,EACrC,KAAK,UAAU,EACf,GAAG,OAAO,MAAM,QAAQ,CAAC,EACzB,GAAG,SAAS,CAAC,QAAQ,OAAO,GAAG,CAAC;AAAA,MACzC,CAAC;AACD,cAAQ,IAAI,2BAA2B,UAAU;AAGjD,YAAM,MAAM,MAAM,oBAAoB,YAAY,aAAa;AAC/D,cAAQ,IAAI,oBAAoB,GAAG;AAGnC,SAAG,WAAW,SAAS;AACvB,SAAG,WAAW,UAAU;AAExB,aAAO,EAAE,IAAI;AAAA,IAEjB,SAAS,OAAY;AACjB,cAAQ,MAAM,qBAAqB,KAAK;AAExC,UAAI,GAAG,WAAW,SAAS,EAAG,IAAG,WAAW,SAAS;AACrD,UAAI,GAAG,WAAW,UAAU,EAAG,IAAG,WAAW,UAAU;AACvD,YAAM;AAAA,IACV;AAAA,EACJ,GAhEK;AAiET,CAAC;",
  "names": ["ffmpeg", "ffmpegInstaller"]
}
