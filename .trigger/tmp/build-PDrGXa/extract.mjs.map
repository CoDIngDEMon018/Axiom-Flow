{
  "version": 3,
  "sources": ["../../../src/trigger/extract.ts"],
  "sourcesContent": ["\r\nimport { task } from \"@trigger.dev/sdk/v3\";\r\nimport ffmpeg from \"fluent-ffmpeg\";\r\nimport ffmpegInstaller from \"@ffmpeg-installer/ffmpeg\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport os from \"os\";\r\nimport { uploadToTransloadit } from \"./utils\";\r\nimport https from \"https\";\r\n\r\n// Set ffmpeg path\r\nffmpeg.setFfmpegPath(ffmpegInstaller.path);\r\n\r\ntype ExtractPayload = {\r\n    videoUrl: string;\r\n    timestamp?: string | number;\r\n};\r\n\r\n// Helper for simple download\r\nasync function downloadFile(url: string, dest: string): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n        const file = fs.createWriteStream(dest);\r\n        https.get(url, (response) => {\r\n            response.pipe(file);\r\n            file.on('finish', () => {\r\n                file.close();\r\n                resolve();\r\n            });\r\n        }).on('error', (err) => {\r\n            fs.unlink(dest, () => { });\r\n            reject(err);\r\n        });\r\n    });\r\n}\r\n\r\nexport const extractTask = task({\r\n    id: \"extract-task\",\r\n    retry: {\r\n        maxAttempts: 3,\r\n    },\r\n    run: async (payload: ExtractPayload) => {\r\n        const { videoUrl, timestamp = \"0\" } = payload;\r\n\r\n        console.log(\"Starting extract task:\", payload);\r\n\r\n        const tmpDir = os.tmpdir();\r\n        const inputPath = path.join(tmpDir, `input-${Date.now()}.mp4`);\r\n        const filename = `frame-${Date.now()}.jpg`;\r\n        const outputPath = path.join(tmpDir, filename);\r\n\r\n        try {\r\n            // 1. Download Video\r\n            await downloadFile(videoUrl, inputPath);\r\n            console.log(\"Downloaded video to:\", inputPath);\r\n\r\n            // 2. Extract Frame\r\n            // fluent-ffmpeg screenshots method\r\n            // timestamp can be \"50%\" or number (seconds)\r\n\r\n            console.log(\"Extracting frame at:\", timestamp);\r\n\r\n            await new Promise<void>((resolve, reject) => {\r\n                ffmpeg(inputPath)\r\n                    .screenshots({\r\n                        count: 1,\r\n                        timestamps: [String(timestamp)],\r\n                        folder: tmpDir,\r\n                        filename: filename,\r\n                    })\r\n                    .on('end', () => resolve())\r\n                    .on('error', (err) => reject(err));\r\n            });\r\n            console.log(\"Extracted frame saved to:\", outputPath);\r\n\r\n            // 3. Upload to Transloadit\r\n            const url = await uploadToTransloadit(outputPath, 'frame.jpg');\r\n            console.log(\"Uploaded result:\", url);\r\n\r\n            // Cleanup\r\n            fs.unlinkSync(inputPath);\r\n            fs.unlinkSync(outputPath);\r\n\r\n            return { url };\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Extract Task Failed:\", error);\r\n            // Cleanup on error\r\n            if (fs.existsSync(inputPath)) fs.unlinkSync(inputPath);\r\n            if (fs.existsSync(outputPath)) fs.unlinkSync(outputPath);\r\n            throw error;\r\n        }\r\n    },\r\n});\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAEA,2BAAmB;AACnB,oBAA4B;AAC5B,OAAO,QAAQ;AACf,OAAO,UAAU;AACjB,OAAO,QAAQ;AAEf,OAAO,WAAW;AAGlB,qBAAAA,QAAO,cAAc,cAAAC,QAAgB,IAAI;AAQzC,eAAe,aAAa,KAAa,MAA6B;AAClE,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpC,UAAM,OAAO,GAAG,kBAAkB,IAAI;AACtC,UAAM,IAAI,KAAK,CAAC,aAAa;AACzB,eAAS,KAAK,IAAI;AAClB,WAAK,GAAG,UAAU,MAAM;AACpB,aAAK,MAAM;AACX,gBAAQ;AAAA,MACZ,CAAC;AAAA,IACL,CAAC,EAAE,GAAG,SAAS,CAAC,QAAQ;AACpB,SAAG,OAAO,MAAM,MAAM;AAAA,MAAE,CAAC;AACzB,aAAO,GAAG;AAAA,IACd,CAAC;AAAA,EACL,CAAC;AACL;AAde;AAgBR,IAAM,cAAc,KAAK;AAAA,EAC5B,IAAI;AAAA,EACJ,OAAO;AAAA,IACH,aAAa;AAAA,EACjB;AAAA,EACA,KAAK,8BAAO,YAA4B;AACpC,UAAM,EAAE,UAAU,YAAY,IAAI,IAAI;AAEtC,YAAQ,IAAI,0BAA0B,OAAO;AAE7C,UAAM,SAAS,GAAG,OAAO;AACzB,UAAM,YAAY,KAAK,KAAK,QAAQ,SAAS,KAAK,IAAI,CAAC,MAAM;AAC7D,UAAM,WAAW,SAAS,KAAK,IAAI,CAAC;AACpC,UAAM,aAAa,KAAK,KAAK,QAAQ,QAAQ;AAE7C,QAAI;AAEA,YAAM,aAAa,UAAU,SAAS;AACtC,cAAQ,IAAI,wBAAwB,SAAS;AAM7C,cAAQ,IAAI,wBAAwB,SAAS;AAE7C,YAAM,IAAI,QAAc,CAAC,SAAS,WAAW;AACzC,iCAAAD,SAAO,SAAS,EACX,YAAY;AAAA,UACT,OAAO;AAAA,UACP,YAAY,CAAC,OAAO,SAAS,CAAC;AAAA,UAC9B,QAAQ;AAAA,UACR;AAAA,QACJ,CAAC,EACA,GAAG,OAAO,MAAM,QAAQ,CAAC,EACzB,GAAG,SAAS,CAAC,QAAQ,OAAO,GAAG,CAAC;AAAA,MACzC,CAAC;AACD,cAAQ,IAAI,6BAA6B,UAAU;AAGnD,YAAM,MAAM,MAAM,oBAAoB,YAAY,WAAW;AAC7D,cAAQ,IAAI,oBAAoB,GAAG;AAGnC,SAAG,WAAW,SAAS;AACvB,SAAG,WAAW,UAAU;AAExB,aAAO,EAAE,IAAI;AAAA,IAEjB,SAAS,OAAY;AACjB,cAAQ,MAAM,wBAAwB,KAAK;AAE3C,UAAI,GAAG,WAAW,SAAS,EAAG,IAAG,WAAW,SAAS;AACrD,UAAI,GAAG,WAAW,UAAU,EAAG,IAAG,WAAW,UAAU;AACvD,YAAM;AAAA,IACV;AAAA,EACJ,GAnDK;AAoDT,CAAC;",
  "names": ["ffmpeg", "ffmpegInstaller"]
}
